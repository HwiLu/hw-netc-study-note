# 基础架构

## 第一章 服务器操作系统基础原理

### 服务器概念

* 服务器：计算机的一种
  * 运行更快
  * 负载更高
  * 价格更贵

### 服务器特性

* 高速度的CPU运算能力
* 长时间的可靠运行
* 强大的IO外部数据吞吐能力

### 服务器按外形分类

* 塔式服务器
* 机架服务器
* 刀片服务器
* 高密度服务器

### 服务器按CPU数量分类

* 单路服务器
* 双路服务器
* 多路服务器

### 服务器按指令集分类

* 精简指令集RISC（非X86架构）
* 复杂指令集CISC（典型代表X86架构）

### 服务器按应用分类

* 数据库服务器
* 应用服务器
* web服务器
* 接入服务器
* 文件服务器

### 服务器技术架构的三大发展方向

* Scale-up纵向扩展架构
* Scale-out横向扩展架构
* Hyper-converged超融合架构

### 纵向扩展架构特性

* 提升单台服务器性能
* 高可靠性
* 高可用性
* 高拓展性
* 主要应用于高性能交易类业务

### 横向扩展架构特性和应用

* 高性能
* 低成本
* 高密度
* 节能低碳
* 统一管理

### 超融合架构特性

* 高速的整体融合
* 简单易用
* 性能优化

### 服务器C/S应用部署架构

* 2层的应用部署架构
* 不利于应用灵活部署
* 不利于较大规模客户应用和推广

### 服务器B/S应用部署架构

* 客户端安装标准的web浏览器即可

### 服务器的系统安装与业务部署

* 操作系统/虚拟化

### Linux的结构

* 硬件
* 内核
  * Linux操作系统的核心
* 外壳
  * 用户和内核之间的命令解释器
* 应用程序

### Linux的特点

* 多任务，多用户
  * CPU时间分片，分给不同的进程
  * 允许多个用户同时登陆使用
* 管道，功能强大的Shell
  * 前一个程序的输出作为后一个程序的输入
  * Shell是一种解释型高级语言
* 安全保护机制，稳定性好
  * 防止系统及其数据未经许可而被非法访问
  * Unix好于Linux，Linux好于Windows
* 用户界面，强大的网络支持
  * 常用命令行界面，同时提供图形界面
  * TCP/IP协议就是Linux的缺省网络协议
* 移植性好
  * 源代码用C语言写成，便于移植到其他计算机上

### Linux用户和用户组

* Linux用户归属于用户组
* 归属于统一用户组的用户对一些公有文件有相同的访问权限
* UID：User ID
* GID：Group ID
* 用户ID信息文件：/etc/passwd
* 组ID信息文件：/etc/group

### passwd文件结构

* 记录被用冒号分为七个部分
  * 用户名
  * 密码
  * UID
  * GID
  * 用户描述
  * 用户家目录
  * shell类型

### group文件结构

* GID和用户组的对应关系

### 用户查询常用命令

* id
  * 查询当前登录用户的GID、UID
* finger
  * 查询当前用户属性信息
* useradd
  * 新增用户
  * useradd [参数] [用户名]
    * -d：设置用户的家目录
    * -m：设置的家目录不存在时自动创建
    * -u：设置用户的UID
    * -g：设置初始GID或组名
    * -s：指定用户的shell
  * /etc/default/useradd配置文件
    * 规定了默认的初始用户组、shell等
    * useradd -D 来查询默认属性
* userdel
  * 删除用户
  * userdel [参数] [用户名]
    * -r：连用户家目录一起删除
* passwd
  * 修改用户密码
  * passwd [用户名]
* usermod
  * 修改用户的属性
  * usermod [用户名]
    * -d：修改用户的家目录
    * -g：修改初始用户组

### 用户组常用管理命令

* groupadd
  * 添加用户组
  * groupadd [参数] [用户组名]
    * -g：指定组ID
* groupdel
  * 删除用户组
  * groupdel [用户组名]
* groupmode
  * 修改用户组信息
  * groupmod [参数] [用户组名]
    * -g：修改组ID
    * -n：修改组名

### Linux目录结构

* 树形结构

| 目录 | 内容 |
| :------------- | :------------- |
| /bin | 构建最小系统所需要的命令 |
| /sbin | 和系统操作有关的命令 |
| /boot | 内核与启动文件 |
| /dev | 各种设备文件 |
| /etc | 系统软件的启动和配置文件 |
| /home | 用户的主目录 |
| /root | 超级用户root的家目录 |
| /usr | 非系统的程序和命令 |
| /var | 系统专用的数据和配置文件 |
| /opt | 可选的应用软件包 |
| /tmp | 临时文件存放点 |

* 绝对路径
  * 由根目录开始写起的文件名或者目录名
* 相对路径
  * 基于当前路径的文件名或者目录名称写法
    * . 代表当前目录
    * .. 代表上一级目录

### 文件和目录基本操作

* pwd
  * 显示当前的工作目录
* cd
  * 变更当前的工作目录
* mkdir [-m 模式] [-p]
  * 用于建立目录，目录的存取模式由掩码（umask）决定
  * -m：按指定存取模式建立目录
  * -p：建立目录时建立其所有不存在的父目录
* rmdir [-p] 目录名
  * 用于删除目录，要求对其父目录具有写权限
  * -p：删除目录和其父目录，可以一次删除多个目录
* cp 源文件或目录 目的文件或目录
  * 用于复制目录，要求对其父目录具有写权限
* mv 源文件或目录 目的文件或目录
  * 用于移动目录，要求对其父目录具有写权限
* rm [-ir] 文件或目录
  * 用于删除文件或目录，要求对其父目录具有写权限
* find [路径] [参数]
  * 在硬盘中查找文件，速度较慢，必须精确匹配
* cat
  * 直接查阅文件内容，不能翻页
* more
  * 翻页查看文件内容
* less
  * 翻页阅读，和more类似，但操作按键比more更弹性
* head
  * 查看文档的前面几行内容，默认10行
* tail
  * 查看文件的最后几行内容，默认10行

### 文件系统的概念

* 文件系统是操作系统用于明确存储和组织计算机数据的方法

### 存储在介质中数据的三个因素

* 文件名
  * 定位存储的位置
* 数据
  * 文件的具体内容
* 元数据
  * 文件有关的信息

### 文件系统的分类

* 是否有日志？
  * 传统型文件系统
  * 日志型文件系统
* 如何查找数据？
  * 索引式文件系统
  * 非索引式文件系统

### 传统型文件系统

* 写入文件内容的时候，先写入数据，再写入元数据
* 典型的传统文件系统是ext2文件系统

### 日志型文件系统

* 写入文件内容的时候，首先写入日志记录文件
* 典型的日志型文件系统有ext3、ReiserFS文件系统
* ext3是对ext2的扩展，在ext2基础上加入日志功能
* ReiserFS使用基于平衡树的文件系统结构，搜索快

### 索引式文件系统

* 文件属性数据和实际内容存放在不同的区块

### 非索引式文件系统

* 只有block，数据需要一个block接一个block读取
* 典型的非索引式文件系统如windows下的FAT
* 磁盘整理就是将分散的block尽量集中起来

### 配置文件系统分区

* 创建分区fdisk
* 创建文件系统mkfs
* 挂载文件系统mount

### 创建分区fdisk

* fdisk 设备名
  * 通过m参数，可以查看按键操作说明
  * 通过p参数，可以得到本磁盘的相关信息
  * 输入n命令，可以新建一个分区
  * 新建分区的步骤：
    1. 选择分区类型
    2. 选择分区开始的磁柱
    3. 决定分区大小
    4. 保存新建的分区
  * 重启服务器或使用partprobe命令通知内核

### 创建文件系统mkfs

* mkfs [参数] 设备名称
  * -t：指定文件系统类型，如ext3
  * -b：指定block大小，单位bytes，ext2/ext3只支持1024,2048,4096三种

### 挂在文件系统mount

* mount 设备名 挂载点
  * -t：指定文件系统类型
  * -b：指定block大小，单位bytes

### 管理Linux文件系统

* 查看分区使用情况
* 查看系统打开的文件
* 修复文件系统

### 查看分区使用情况

* df：查看文件系统的磁盘空间占用情况
  * -h：以容易理解的格式打印出文件系统大小
  * -i：显示inode信息而非块使用量
* du：查询文件或目录的磁盘使用空间
  * -a：显示目录下的每个文件所占的磁盘空间
  * -s：只显示大小的总和
  * -h：以容易理解的格式输出文件大小信息

### 查看系统打开的文件

* lsof：显示系统打开的文件
  * lsof filename：显示打开指定文件的所有进程
  * lsof -c string：显示以指定字符开头的进程所有打开的文件
  * lsof -u username：显示所属user相关进程打开的文件

### 修复文件系统

* fsck：检查文件系统并尝试修复错误
  * 执行fsck时，必须将要修复的设备进行umount后，再执行fsck命令
* e2fsck：检查和修复ext2和ext3文件系统

### LVM原理

* LVM是logical Volumn Manager的简写

### LVM架构

* PP：Physical Partition
* PV：Physical Volumn
* PE：Physical Extends
* VG：Volume Group
* LE：Logical Extends
* LV：Logical Volumn

### LVM的优点

* 使用LVM：
  * 文件系统可以跨多个磁盘
  * 动态地扩展文件系统大小
  * 增加新磁盘到LVM的存储池中

### LVM要点

* 使用要点：
  * 按需分配文件系统大小
  * 把不同的数据放在不同的卷组中

### LVM配置流程

1. 物理分区阶段
  * fdisk
2. PV阶段
3. VG阶段
4. LV阶段
5. 操作系统使用阶段

### 物理卷管理

* pvcreate
  * 创建物理卷
  * 将普通的分区加上pv属性
* pvscan
  * 查看物理卷信息
* pvdisplay
  * 查看各个物理卷的详细参数
* pvremove
  * 删除物理卷
  * 删除分区上的pv属性

### 卷组管理

* vgcreate
  * 创建卷组
* vgscan
  * 查看卷组的信息
* vgdisplay
  * 查看卷组的详细参数
* vgreduce
  * 缩小卷组，把物理卷从卷组中删除
* vgextend
  * 扩展卷组，把某个物理卷添加到卷组中
* vgremove
  * 删除卷组

### 逻辑卷管理

* lvcreate
  * 创建逻辑卷
* lvscan
  * 查看逻辑卷的信息
* lvdisplay
  * 查看逻辑卷的具体参数
* lvextend
  * 增大逻辑卷大小
* lvreduce
  * 减小逻辑卷大小
* lvremove
  * 删除逻辑卷

### 管理文件系统空间

* 增大文件系统空间
  * 先卸载逻辑卷
  * 然后通过vgextend，lvextend等命令增大lv空间
  * 再使用resize2fs将逻辑卷容量增加
  * 最后将逻辑卷挂载到目录树
* 缩小文件系统空间
* 先卸载逻辑卷
* 然后使用resize2fs将逻辑卷容量减小
* 然后通过lvreduce命令减小lv空间
* 最后将逻辑卷挂载到目录树

### 查看网口配置

* ifconfig 接口
  * 查看IP地址、广播地址和掩码等

### 修改网口配置

* ifconfig 网口 [参数]
  * 设置网口的参数
  * 重启网络服务或操作系统后失效
* /etc/sysconfig/network/ifcfg-[网口]
  * 编辑配置文件配置网口
  * 使用ifup命令，启动网口

### 查询路由表

* route
  * 查询本机路由表
    * destination：目的网段或主机，如果是default，表示为默认路由
    * getway：网关
    * genmask：掩码
    * Flags：标记
      * U：可用
        G：需要通过网关转发
        H：代表目的地址是一个主机
    * Iface：代表接口

### 新增路由

* route add [-net|-host] [netmask Nm] [gw Gw] [[dev] If]
  * 新增到网段或者主机的路由
  * 新增路由数据保存在内存中，系统重启失效
* /etc/sysconfig/network/routes
  * 用来保存静态路由数据
  * 需要重启网络服务才能生效

### 侦测网络

* ping
  * ping [参数] 目的地址
  * -c：后接执行ping的次数
  * 检查网络是否通畅或者网络连接速度
* traceroute
  * traceroute <地址 or 主机名>
  * 侦测数据包从源到目的经过的路由

### 配置FTP服务

* 使用root用户登录系统，执行yast命令
* 在yast界面，选择Services > Network Services(xinetd). 启用vsftpd服务
* 修改/etc/vsftpd.conf配置文件，取消如下的注释：
  * ascii_upload_enable 上传权限
  * ascii_download_enable 下载权限
  * local_enable 本地系统用户FTP权限
  * write_enable 用户写权限
  * 设置anonymous_enable=NO
  * 设置listen=NO
* 修改/etc/ftpusers配置文件，在root前加注释#
* 重启xinetd服务：/etc/init.d/xinetd restart

### 配置Telnet服务

* 使用root用户登录系统，执行yast命令
* 在yast界面，选择Services > Network Services(xinetd). 启用Telnet服务
* 修改/etc/pam.d/login
  * 在auth required pam_securetty.so前加注释#

### Linux进程管理

* 程序:
  * 文件中保存的一系列可执行命令
* 进程：
  * 加载到内存中的程序，由CPU运行
* 守护进程
  * 常驻内存，与终端无关的系统进程
* 用户进程
  * 用户通过终端加载的进程

### 查看进程

* ps
  * 静态查看某一时间点进程信息
  * a 显示现行终端机下的所有程序
  * x 显示所有程序，不以终端机来区分
  * u 以用户为主的格式来显示程序状况
  * f 用ASCII字符显示树状结构
* top
  * 默认每3s刷新一次，按CPU使用率排序
* pstree
  * 用ASCII字符显示树状结构
  * -p 显示进程ID
  * -u 显示用户名称

### 结束进程

* kill
  * 结束进程和进程号PID，系统可能响应可能忽略
  * kill -9 PID，强制终止进程
* killall
  * 终止统一进程组内的所有进程

### 任务管理

* 任务：
  * 登录系统取得shell之后，在单一终端接口下启动的进程
* 前台：
  * 在终端接口上，可以出现提示符让用户操作的环境
* 后台：
  * 不显示在终端接口的环境

### 任务管理相关命令

* &
  * 直接将程序放入后台处理
* jobs
  * 查看当前shell的后台任务
* ctrl+z
  * 将正在运行的任务放入后台暂停
* fg %[job ID]
  * 将任务放入前台执行
* bg %[job ID]
  * 将任务放入后台执行

### 管理周期计划任务

* crontab [-u user] [-e|-l|-r]
  * -u：指定用户
  * -e：编辑crontab任务内容
  * -l：查阅crontab任务内容
  * -r：移除所有crontab的任务内容
* crontab相关配置文件
  * 使用crontab -e编辑时，程序会直接调用vi接口，程序路径是/usr/sbin/cron
  * 系统计划任务保存在/etc/crontab文件中
  * /var/spool/cron/tabs下面有对应用户名的crontab，对应用户级别的任务配置
  * /var/crontab对应系统级别的任务配置

### 管理定时任务

* at
  * 安排一个任务在未来执行，必须先启用atd进程
  * -l：相当于atq，列出当前at任务
  * -d：相当于atm，删除一个at任务
  * -c：查看任务的具体内容
  * at HH:MM：今日执行，若已超过则为明天执行
  * at HH:MM YYYY-MM-DD：指定具体的执行日期和时间
  * at now + number [minutes|hour|days|weeks]：当前时间往后多长时间执行
  * at HH:MM + number [minutes|hour|days|weeks]：某个时间点+分钟|小时|天|星期执行

### 监控系统是否正常启动

* Kernel Ring Buffer
* dmesg | less
* /var/log/boot.msg

### 监控系统硬件信息

* cat /proc/...
  * cpuinfo：CPU信息
  * devices：已加载的设备信息
  * bus：系统总线信息
  * scsi：设备信息
  * net：网卡设备信息
* hwinfo
  * 显示所有硬件相关信息
  * --disk 显示磁盘信息
  * --cpu 显示CPU信息
  * --memory 显示内存信息
  * --network 显示网卡信息
  * --short 显示硬件的摘要信息
* fdisk
  * 查看硬盘信息
  * -l：查看服务器所挂硬盘个数及分区情况
* iostat
  * 查询CPU和磁盘IO的统计信息
  * -c 仅显示CPU统计信息
  * -d 仅显示磁盘统计信息
  * -k 以k为单位显示每秒的磁盘请求数
* lspci
  * 列出所有PCI设备
  * -v 显示PCI接口装置的详细信息
  * -vv 比-v更详细的信息

### 监控系统和进程

* ps
  * 用来显示当前进程状态，静态
* top
  * 即时显示进程的动态，可以用来查看进程使用的cpu，内存等
* uptime
  * 查看系统已经开机的时间以及系统平均负载
* uname
  * 查看系统版本相关信息，如内核号
* netstat
  * 显示与IP、TCP、UDP协议相关的统计数据，用于检验本机各端口的网络连接情况
  * t：仅显示tcp相关选项
  * u：仅显示udp相关选项
  * p：显示建立相关连接的程序名
  * 仅列出正在监听的服务状态
  * 拒绝显示别名，能显示数字的全部转化成数字

### 监控用户登录信息

* who
  * 查看当前登录系统的用户
  * -H：显示各栏位的标题信息列
  * -m：效果同who am i，显示出自己在系统中的用户名，登录终端，登录时间
* w
  * 查看当前登录的用户及用户当前的工作
  * -u：后面接user，查看具体用户信息
* finger [参数] [用户]
  * 查看用户详细信息
  * -s：短格式显示用户信息
  * -l：长格式显示用户信息
* last [参数]
  * 查看曾经登录过系统的用户
  * -n num：设置列出名单的显示列数
  * -F：显示登录和登出的详细信息
* lastlog [参数] [用户]
  * 查看用户前一次登录的信息
  * -t days：查看距今天n天内登录了系统的用户和最近一次登录信息
  * -u：显示登录和登出的详细信息
