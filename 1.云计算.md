# 云计算

## 第一章 云计算概念和价值

### 云计算的关键特征

* 按需自助服务
* 无处不在的网络接入
* 与位置无关的资源池
* 快速弹性
* 按使用付费

### 技术视角：云计算=计算/存储的网络

云计算是通过网络把海量的服务器和存储进行组网并使用云平台软件对硬件设备虚拟化以支撑上层业务和应用运行的应用网络。

云计算包含两个部分：云设备和云服务。
* 云设备：用于提供资源的海量的服务器和存储以及交换机。
* 云服务：用于把资源进行池化的云平台软件以及给上层提供服务的云管理软件和业务应用软件。

云计算技术的发展趋势：
* 海量低成本服务器代替专有大型机、小型机、高端服务器。
* 分布式软件代替传统单机操作系统。
* 自动管控软件代替传统集中管理。

### 商业视角：云计算=信息电厂

* 计算和存储：从局域网向互联网迁移
* 软件：从终端向云端迁移
* 软件和硬件解耦，实现硬件共享

### 云计算产生的背景

* 需求推动
* 技术进步
* 商业模式转变

### 云计算的演进历程

* 并行计算：所有的计算任务在一台计算设备里面进行处理，把一个大的任务分成多个进程进行处理。

* 分布式计算：把分布在各地的计算设备通过网络组合成一个统一的计算模式，要求各地的计算设备是同构的。

* 网格计算：分布式计算的一个发展，分布于各地的计算设备可以是不同构的。

* 云计算

### 云计算的部署模式

* 私有云：提供者和使用者相同。
* 公有云：云服务提供者和使用者不同。
* 混合云：两种模式的混合。

### 云计算的商业模式

IaaS：基础设施即服务，指的是把基础设备以服务形式提供给最终用户使用。包括计算、存储、网络和其他的计算资源，用户可以部署和运行任意软件，包括操作系统和应用程序。
PaaS：平台即服务，指的是把二次开发的平台以服务形式提供给最终用户使用，客户不需要管理或控制底层的云计算基础设施，但能控制部署的应用程序开发平台。
SaaS：软件即服务，提供给消费者的服务是运行在云计算基础设备上的应用程序。

### 行业客户反应的困难与挑战

* 复杂性与平滑过渡
* 可靠性或SLA
* 工作负载可迁移性
* 数据安全性
* 厂商锁定
* 看不到投资回报

### 云计算的价值——智能资源调度

* 负载均衡
* 热迁移实现节能减排

### 云计算的价值——提高资源利用率

* 资源共享
* 分时共享

### 云计算的价值——分布式计算存储

* 动态加入和撤出

### 云计算的价值——统一管理

### 云计算的价值——业务快速部署

* 减少业务部署时间

### 虚拟化的起源

* 60年代在大型机上虚拟技术已经有所应用
* 99年在小型机上已经出现逻辑分区的应用
* 2000年x86平台虚拟技术开始出现
* 2001年x86平台虚拟化技术在服务器上应用

### 虚拟化技术推动力

* CPU速度越来越快，超出软件对硬件性能的要求
* Intel和AMD在CPU里加入虚拟指令
* 企业成本压力
* 环保压力
* 不断增长的业务压力

### 虚拟化的概念

* 虚拟化是指通过虚拟化技术将一台计算机虚拟为多台逻辑计算机，在一台计算机上同时运行多个逻辑计算机，每个逻辑计算机可运行不同的操作系统，并且应用程序都可以在相互独立的空间内运行而互不影响，从而显著提高计算机的工作效率。

### 虚拟化的主要内容

* 计算虚拟化
  * CPU虚拟化
  * 内存虚拟化
  * I/O虚拟化
* 存储虚拟化
  * 裸设备 + 逻辑卷
  * 存储设备虚拟化
  * 主机存储虚拟化 + 文件系统
* 网络虚拟化
  * VPN
  * VLAN

### 虚拟化的本质

* 分区：在单一物理服务器上可同时运行多个虚拟机，按需使用硬件资源池中的资源
* 隔离：每个虚拟机之间都是隔离的，业务互不影响
* 封装：整个虚拟机的执行环境封装在独立的文件中，可以通过移动和复制这些文件来移动和复制虚拟机
* 独立：相对于硬件独立，虚拟机无需任何修改可在任何物理服务器上运行实现热迁移

## 第二章 OpenStack基础原理

### OpenStack起源

* 计算服务Nova
* 对象存储服务Swift
* 镜像服务Glance
* 网络服务Neutron
* 身份认证服务Keystone
* 计量服务Celimeter
* 块存储服务Cinder
* 编排服务Heat

### OpenStack架构

* Keystone
  * 身份服务
  * 管理用户，租户，角色，服务和服务端点
  * 可以支持SQL，PAM，LDAP作为后端
* Nove
  * 计算服务
    * 计算节点——运行虚拟机的hypervisor
  * 分布式控制器
    * 负责处理器调度策略及API调用等
* Glance
  * 镜像服务
  * 镜像格式：raw，qcow，vhd，vmdk，iso
  * 后端存储：swift，filesystem，AmazonS3
* swift
  * 对象存储服务
  * 提供存取数据的易用服务
* Neutron
  * 网络服务
  * 提供支持/实现SDN框架
  * 基于插件的模型
* cinder
  * 块存储服务（卷服务）
  * 持久化磁盘
  * 基于插件的架构便于扩展
* horizon
  * 仪表板
  * 自服务界面
  * 基于云管理功能
* ceilometer
  * 提供openstack平台组件的监控
  * 计量服务

### Nova介绍

* OpenStack云中的计算组织控制器
* 管理OpenStack云中实例的生命周期
* 管理计算资源、网络、认证所需的可扩展性平台

* KVM：
  * 内核虚拟化，OpenStack默认的Hypersvisor
* Qemu：
  * KVM的替补角色，没有KVM执行效率高，不支持全虚拟化
* Flavor：
  * 新建虚拟机的配置列表，虚拟机模板
* Keypair：
  * ssh连接访问实例的密钥对
* 安全组：
  * 用来控制实例访问策略的容器
* 安全组规则：
  * 用来控制实例访问的具体策略

### Nova架构

* API：提供统一风格的restful API接口，作为入口，接收用户请求
* SCHEDULER：负责调度，将实例分配到具体的计算节点
* CONDUCTOR：主要负责与Nova数据库交互
* COMPUTE：运行在计算节点上，用于虚拟机实例的创建和管理
* MESSAGE QUEUE：组件间的数据传递

### Nova功能特性

* 实例的生命周期管理
* 管理平台的计算资源
* 统一风格的RestAPI
* 支持透明的hypervisor
* 各个模块通过消息队列实现交互

### Swift简介

* 高可用分布式对象存储
* 为Nova组件提供虚拟机镜像存储
  * 无需采用raid，通过在软件层面引入一致性散列技术和数据冗余，牺牲一定程度的数据一致性来达到高可用和可伸缩性
  * 支持多租户模式下容器和对象读写操作
* 适用于互联网应用场景下非结构化数据存储

### 常用术语：

* Account：
  * 用户定义的管理存储区域
* Container：
  * 存储隔间，类似于文件夹或目录
* Object：
  * 包含了基本的存储实体和它自身的元数据
* Ring：
  * 记录了磁盘上存储的实体名称和物理位置的映射关系
* Region：
  * 地域，从地理位置上划分的一个概念
* Zone：
  * 可用区，按照独立的供网、供电基础设施划分。
* Node：
  * 节点，存储服务器
* Disk：
  * 磁盘，物理服务器上的存储设备
* Cluster：
  * 群集，为冗余考虑的部署架构

### Swift功能

* Swift在物理结构上往往会存储对象的多个副本，通常按照物理位置的特点，将对象拷贝到不同的物理位置上，来保证数据的可靠性


### Keystone简介

* 提供身份验证、服务规则和服务令牌功能
* 任何服务之间相互调用，都需要经过Keystone的身份验证

### 常用术语

* User：
  * OpenStack最基本的用户。
* Project：
  * 指分配给使用者的资源的集合。
* Role：
  * 代表一组用户可以访问资源的权限。
* Domain：
  * 定义管理边界，可以包含多个project/tenant、user、role等。
* Endpoint：
  * 服务的URL路径，暴露出来的访问点

### Neutron简介

* 提供网络服务的核心组件
* 基于软件定义网络的思想
  * 实现上充分使用Linux系统中各种网络相关技术
  * 支持第三方插件

### 常用术语

* Bridge-int:
  * 实现内部网络功能的网桥
* Br-ex:
  * 跟外部网络通信的网桥
* Neutron-server：
  * 提供API接口
* Neutron-L2-agent：
  * 实现二层网络通信的代理
  * 用于管理vlan的插件，接受Neutron-server的指令来创建VLAN
* Neutron-DHCP-agent:
  * 为子网自动分发IP地址
* Neutron-L3-agent:
  * 租户网络和floating IP间地址转换
* Neutron-metadata-agent:
  * 响应Nova的metadata请求
* LBaaS agent：
  * 为多台实例和open vswitch agent提供负载均衡服务

### Glance简介

* 为Nove提供镜像服务
* 通常不负责镜像的本地存储
* 实现对镜像的管理

### Glance镜像格式

* Raw
* vhd
* vdi
* iso
* qcow2
* aki ami

### Glance组件

* Glance-api:
  * 负责提供镜像服务的rest api服务
* Glance-registry：
  * 主要负责与Glance使用的数据库交互

### Cinder介绍

* 为虚拟机实例提供volume卷的块存储服务
* 一个volume可以同时挂载在多个实例上
* 共享的卷同时只能被一个实例进行写操作

### 支持的文件系统类型

* LVM/ISCSI
* NFS
* NetAPP NFS
* Gluster
* DELL Equall Logic

### 常用术语

* Volume备份：
  * volume卷的备份
* volume快照：
  * 卷在某个时间点的状态
* Cinder API：
  * 为Cinder请求提供统一风格的Rest API服务
* Cinder Scheduler：
  * 负责为新建卷指定块存储设备
* Cinder Volume：
  * 负责与存储设备的块设备交互，实现卷的创建、删除、修改等操作
* Cinder Backup：
  * 备份服务负责通过驱动和后端的备份设备打交道

### Ceilometer介绍

* OpenStack中的数据监控器
* 为流量计费提供数据支撑

### 核心概念

* Ceilometer-agent-compute:
  * 收集计算节点上信息的代理
* Ceilometer-agent-central:
  * 运行在控制节点上，轮询服务的非持久化数据
* Ceilometer-collector:
  * 运行在控制节点上，监听Message Bus，将收到的消息写入到数据库中
* Storage
* API server
* Message Bus

### Heat介绍

* OpenStack核心项目之一
* 提供基于模板的编排服务

### 常用术语

* Stack：
  * 指的是Heat要用到的所有设施和资源的集合
* Heat template：
  * 是以.yaml结尾的文件，用于创建stack
* Heat-api：
  * 提供rest api服务，将api请求发送给heat engine去执行
* Heat-api-cfn：
  * 支持亚马逊格式访问的Rest api
* Heat-engine：
  * Heat的核心模块，接收API请求在openstack中创建资源

### Heat组件

* Heat-cfntools Heat-init:
  * 在镜像中完成虚拟实例操作任务的工具
* Heat-api-cloudwatch：
  * 监控编排服务
* Resource
  * 底层各种服务抽象的集合
* Heat-client：
  * 调用访问其他各个组件的client工具

## 第三章 Docker基础原理

### 定义标准 + 服务应用

* 基础设施标准化
* 应用交付标准化
* 运维管理标准化
* 分发部署标准化

### namespace

* UTS：主机名与域名
* IPC：信号量、消息队列和共享内容
* PID：进程编号
* Network：网络设备、网络栈、端口
* Mount：文件系统
* User：用户和用户组

### cgroups

* cgroups实现了对系统资源的限额和度量

### 其他相关Linux Kernel技术

* selinux：增强容器的访问控制
* netlink：完成docker容器的网络配置
* capabilities：将超级用户root的权限分割成了不同的capabilities，从而更严格控制容器权限
* apparmor

### 容器管理

* Lxc和libcontainer

### Docker的优势

| 对比项 | VM | Docker |
| :------------- | :------------- | :------------- |
| 隔离性 | 强 | 较弱 |
| 计算资源开销 | 大 | 小 |
| 镜像大小 | 几百MB至几GB | 可小至几MB |
| 启动速度 | 数秒至数分钟 | 毫秒级 |
| 快速扩展能力 | 一般 | 强 |
| 跨平台迁移能力 | 一般 | 强 |
| 对微服务架构的支持 | 一般 | 强 |
| 对Devops的支持 | 一般 | 强 |

### 容器、镜像、仓库

* 容器：承载相关应用的载体
* 镜像：安装了相关应用的模板
* 仓库：存储镜像的地方

### Docker容器

* Docker容器的状态
  * Running
  * Stopped
  * Paused

### Docker数据卷

* 数据卷存在的意义
  * 容器运行时可使用数据卷中的文件
  * 数据卷可在多个容器间共享
  * 存储容器运行过程中产生的数据
  * 方便主机对容器数据的访问

### Docker网络

* Docker的四种网络模式
  * Bridged：容器可以与主机上的容器、主机和主机外部通信
  * HOST：只能与主机通信
  * Container：只能与容器之间通信
  * None：无网络

### Docker的落地

* 从“容器运行”到生成使用

### Orchestration

* 广义的编排
  * 集群管理
    * 配置管理
    * 资源视图
    * 节点增删
    * 高可用
  * 容器调度
    * 容器部署
    * 调度策略
    * 互斥
  * 故障恢复
    * 主机检查
    * 容器检查
  * 应用编排
    * 应用编排

### 三大Orchestration工具

| 编排工具 | 厂商 | 发布时间 | 说明 |
| :------------- | :------------- | :------------- | :------------- |
| Swarm | Docker | 2014年 | 内置于Docker，和Compose一起使用 |
| Mesos | Apache | 2007年 | 一般会结合marathon、Zookeeper一起使用 |
| Kubernetes | Google | 2014年 | 结合Etcd一起使用 |

### 负载均衡与服务发现

* 常用的负载均衡技术：haproxy、LVS、F5、Nginx
* 常用的服务发现技术：Etcd、Zookeeper、Consul

### 日志管理

* 容器时代，对日志处理平台的要求是：集中化、海量存储、灵活过滤、快速查询、伸缩性架构、高可用、强大的UI

### Docker监控

* WANT原则：
  * Watching
  * Answer
  * Notify
  * Track
* 常用的监控工具
  * Zabbix
  * Nagios
  * cAdvisor
  * Datadog
  * Scout

### Docker平台架构

* 基础平台
  * 集群管理
  * 网络存储
  * 镜像管理
  * 容器调度
  * 应用编排
* 集成功能
  * 弹性架构、负载均衡
  * 性能监控、日志管理
  * 用户中心、租户中心
  * 持续交付、版本控制
* Web UI
* API

### Monolithic单体式架构简介

* 单块架构
  * 紧耦合，所有功能都在一个进程中
  * 基于整个系统扩展
* 微服务架构
  * 松耦合，功能在不同微服务的进程中
  * 基于独立服务，按需扩展
* Monolithic单体式架构指的是尽管是模块化逻辑，但是最终还是会打包并部署为一个单一应用

### Monolithic单体式架构的优缺点

* Monolithic单体式架构的优缺点很鲜明

### 单体式架构面临的挑战

* 维护成本
* 缺陷修复成本
* 系统扩展成本

### 微服务架构模式倡导的做法

* 提倡将Monolithic单体式架构应用划分为一系列小的服务，服务之间相互协调、相互配合，为用户提供服务

### 向微服务架构演进的推荐顺序

* 优点：包括每个服务足够内聚，代码容易理解，开发效率高
* 顺序：规划->中间件和DB->服务

### 微服务架构设计需要遵循的模式

* 比较知名的“12-Factor”

### “12-Factor”方法论

* 使用标准化流程自动配置，从而使新的开发者花费最少的学习成本加入这个项目
* 和操作系统之间尽可能的划清界限
* 在各个系统中提供最大的可移植性
* 适合部署在现代的云计算平台上，从而在服务器和系统管理方面节省资源
* 将发开环境和生产环境的差异降到最低，并使用持续交付，实施敏捷开发，可以在工具、架构和开发流程不发生明显变化的前提下实施扩展

### 基准代码

* 基准代码和应用之间总是保持一一对应的关系：一旦有多个基准代码，就不能称为一个应用，而是一个分布式系统
* 多个应用共享一份基准代码是有悖于12-Factor原则的

### 依赖关系

* 应用程序不会隐式依赖系统级的类库。它一定通过依赖清单，确切地声明所有依赖项
* 在运行过程中通过依赖隔离工具来确保程序不会调用系统中存在但清单中未声明的依赖项

### 配置

* 环境变量可以非常方便地在不同的部署间做修改，却不动一行代码
* 与配置文件不同，不小心把它们签入代码库的概率微乎其微
* 与一些传统的解决配置问题的机制（比如Java的属性配置文件）相比，环境变量与语言和系统无关

### 后端服务

* 12-Factor应用不会区别对待本地或第三方服务，对应用而言，两种都是附加资源
* 12-Factor应用支持任意部署。如，可以在不进行任何代码改动的情况下，将本地MySQL数据库换成第三方服务

### Docker本质

* Docker比VM虚拟机更加轻量

### Docker流行起来的因素

* 每个Docker里面装一个服务或应用，一个服务器上可以运行多个Docker

### 集群分布你的微服务

* 每个Docker中运行一个微服务

### Docker对传统PaaS平台的挑战

* Docker是一种崭新的PaaS微服务

### Docker的安全性

* Docker利用容器将资源进行有效隔离

### 客户端如何访问这些服务

* 后台有N个服务，前台就需要记住管理N个服务，一个服务下线、更新、升级，前台就要重新部署，这明显不符合拆分的理念

### 服务之间如何通信

* IPC
  * 同步调用rest
  * RPC异步消息调用

### 服务发现

* 基本都是通过zookeeper等类似技术做服务注册信息的分布式管理

### 服务挂了怎么办？

* 重试机制、限流、负载均衡、降级（本地缓存）
* HYSTRIX

### 微服务简化

* 基于容器技术的云服务将极大的简化容器化微服务创建、集成、部署、运维的整个流程，从而推动微服务在云端的大规模实践

### 微服务创建

* 假设用户的微服务程序，存储于GitHub等代码托管服务中，用户可以将这个代码仓库构建成容器镜像，并保存在云仓库中，用户可以将这个微服务一键部署到容器云平台
* 云平台提供了持续集成的功能，用户可以选择是否使用

### 微服务集成

* 用户可以自由组合、复用数以万计的容器化微服务，像搭积木一样轻松集成应用

### 微服务部署

* 微服务由于组件数量众多，云端部署成为实践上的一个难点
* 容器云平台容器为应用发布的载体，用户不必指定传统部署方式中繁琐的步骤，只需要提供容器镜像和简单的容器配置，平台会将整个部署流程自动化

### 微服务运维

* 微服务由于独立进程众多，部署后的运维、管理成为实践上的另一个难题
* 容器云平台完全屏蔽底层云主机和基础架构运维，让用户专注于应用
* 通过容器编排、自动修复、自动扩展、监控日志等高级应用生命周期服务，实现容器化微服务的智能托管
